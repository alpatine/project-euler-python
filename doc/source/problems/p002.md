# Project Euler 2 - Even Fibonacci Numbers

## Problem Description
Project Euler Problem 2: https://projecteuler.net/problem=2

The problem reads:

> Each new term in the Fibonacci sequence is generated by adding the previous
> two terms. By starting with 1 and 2, the first 10 terms will be:
> 
> 1, 2, 3, 5, 8, 13, 21, 34, 55, 89
> 
> By considering the terms in the Fibonacci sequence whose values do not exceed
> four million, find the sum of the even-valued terms.

## A Brute Force Approach
Another problem that can be approached directly with brute force code. First we
will need a function to generate the Fibonacci numbers. This function will
accept an upper Fibonacci value (which will NOT be included in the output) and
will output the Fibonacci sequence as defined above.

``` python
def fibonacci(stop: int) -> Iterator[int]:
    a, b = 1, 2
    while a < stop:
        yield a
        a, b = b, a+b
```

With this function defined we can simply test every Fibonacci number less then
4,000,000 and sum any that are even.

``` python
sum(x for x in fibonacci(upper) if x % 2 == 0)
```

This code runs well within the 1 minute time limit to give the correct answer of
4613732.

## Direct Calculation
It is possible to calculate the result directly using a formula. Here we will
derive that formula and evaluate it.

First, let's introduce some notation for the Fibonacci sequence. When working
with this sequence it's often helpful to start with the 0th Fibonacci number
being 0, and the 1st Fibonacci number being 1. We then introduce $F_n$ to
represent the $n$ th fibonacci number.

$$\begin{aligned}
    F_0 &= 0 \\
    F_1 &= 1 \\
    F_{n+2} &= F_{n+1} + F_n
\end{aligned}$$

This problem starts counting the Fibonacci sequence at $F_2=1$. When working
with our notation we need to remember that we have introduced $F_0=0$ and
$F_1=1$ at the start. At first this may appear to throw the answer out by 1, but
$F_1=1$ is odd and so it will not be included in the sum of the even Fibonacci
numbers.

## Even Fibonacci Numbers
Let's take a closer look at the Fibonacci numbers to see if we can identify any
pattern for the even terms. Putting the Fibonacci numbers into a table gives:

$$\begin{array}{r|ccccccccccc}
    n & 0 & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & 10 \\
    \hline
    F_n & 0 & 1 & 1 & 2 & 3 & 5 & 8 & 13 & 21 & 34 & 55
\end{array}$$

It appears that $F_n$ is even only when $n$ is a multiple of 3. We will now
prove at all even Fibonacci numbers are of the form $F_{3n}$.

$$\begin{aligned}
    F_{n+3} &= F_{n+2} + F_{n+1}
        && \text{(definition of \(F_n\))} \\
    &= F_{n+1} + F_n + F_{n+1}
        && \text{(definition of \(F_n\) applied to \(F_{n+2}\))} \\
    &= 2F_{n+1} + F_n
        && \text{(collect like terms)} \\
    &\equiv F_n \pmod 2
        && \text{(reduce \(\bmod 2\))} \\
\end{aligned}$$

That relationship implies the following:

$$\begin{aligned}
    F_0 &\equiv F_3 \equiv F_6 \equiv \dots\equiv F_{3n} \pmod 2 \\
    F_1 &\equiv F_4 \equiv F_7 \equiv \dots \equiv F_{3n+1} \pmod 2 \\
    F_2 &\equiv F_5 \equiv F_8 \equiv \dots \equiv F_{3n+2} \pmod 2
\end{aligned}$$

But, looking at the first three Fibonacci numbers:

$$\begin{aligned}
    F_0 &= 0 \equiv 0 \pmod 2 &&\Rightarrow F_{3n} \equiv 0 \pmod 2 \\
    F_1 &= 1 \equiv 1 \pmod 2 &&\Rightarrow F_{3n+1} \equiv 1 \pmod 2 \\
    F_2 &= 1 \equiv 1 \pmod 2 &&\Rightarrow F_{3n+2} \equiv 1 \pmod 2 \\
\end{aligned}$$

This shows that all of the even Fibonacci numbers are all of the form $F_{3n}$.

## Sum of Fibonacci Numbers
We will define $S_n$ to be the sum of the first $n$ Fibonacci numbers:

$$ S_n = \sum_{j=0}^n F_j = F_0 + F_1 + F_2 + \cdots + F_n $$

Adding the sums to our Fibonacci table gives:

$$\begin{array}{r|ccccccccccc}
    n & 0 & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & 10 \\
    \hline
    F_n & 0 & 1 & 1 & 2 & 3 & 5 & 8 & 13 & 21 & 34 & 55 \\
    \hline
    S_n & 0 & 1 & 2 & 4 & 7 & 12 & 20 & 33 & 54 & 88 & 143
\end{array}$$

Close inspection of the table reveals:

$$\begin{aligned}
    S_0 &= 0 = 1 - 1 = F_2 - 1 = F_{0+2} - 1 \\
    S_1 &= 1 = 2 - 1 = F_3 - 1 = F_{1+2} - 1 \\
    S_2 &= 2 = 3 - 1 = F_4 - 1 = F_{2+2} - 1 \\
    S_3 &= 3 = 5 - 1 = F_5 - 1 = F_{3+2} - 1 \\
    S_4 &= 7 = 8 - 1 = F_6 - 1 = F_{4+2} - 1
\end{aligned}$$

It appears that in general we have $S_n=F_{n+2}-1$. We will now use induction to
prove that this is the case for $n \geq 0$. We start with the base case:

$$\begin{aligned}
    \text{Let } n &= 0 \\
    F_{n+2} - 1 &= F_2 - 1 \\
    &= 1 - 1 \\
    &= 0 \\
    &= S_0
\end{aligned}$$

Now we will assume the $n=k$ case and show that it implies the $n=k+1$ case. We
will have shown this if we can show that $S_{k+1}=F_{(k+1)+2}-1$:

$$\begin{aligned}
    \text{Assume } S_k &= F_{k+2} - 1
        && \text{(induction hypothesis)} \\
    \text{Consider } S_{k+1} &= \sum_{j=0}^{k+1} F_k
        && \text{(definition of \(S_n\))} \\
    &= F_{k+1} + \sum_{j=0}^{k} F_k
        && \text{(extracting the \((k+1)\)th term)} \\
    &= F_{k+1} + S_k
        && \text{(definition of \(S_n\))} \\
    &= F_{k+1} + F_{k+2} - 1
        && \text{(induction hypothesis)} \\
    &= F_{k+3} - 1
        && \text{(definition of Fibonacci numbers)} \\
    &= F_{(k+1)+2} - 1
\end{aligned}$$

## Sum of Even Fibonacci Numbers
We now have the tools we need to find a formula for the sum of the first $n$
even Fibonacci numbers. We will define $E_n$ to be the sum of the first $n$ even
Fibonacci numbers:

$$\begin{aligned}
    E_n &= \sum_{j=0}^n F_{3j} \\
    &= \sum_{j=1}^n F_{3j}
        && \text{(subtract \(F_0 = 0\))} \\
    &= \sum_{j=1}^n {\frac{1}{2}(F_{3j} + F_{3j})} \\
    &= \frac{1}{2} \sum_{j=1}^n {(F_{3j} + F_{3j})}
        && \text{(factorisation)} \\
    &= \frac{1}{2} \sum_{j=1}^n {(F_{3j} + F_{3j-1} + F_{3j-2})}
        && \text{(definition of \(F_n\))} \\
    &= \frac{1}{2} \left( (F_3 + F_2 + F_1) + \cdots
                        + (F_{3n} + F_{3n-1} + F_{3n-2}) \right)
        && \text{(expand sum)} \\
    &= \frac{1}{2} (F_1 + F_2 + F_3 + \cdots + F_{3n})
        && \text{(rearranging)} \\
    &= \frac{1}{2} (F_0 + F_1 + F_2 + F_3 + \cdots + F_{3n})
        && \text{(adding \(F_0 = 0\))} \\
    &= \frac{1}{2} \sum_{j=0}^{3n} F_j
        && \text{(condense sum)} \\
    &= \frac{1}{2} S_{3n}
        && \text{(definition of \(S_n\))} \\
    &= \frac{1}{2} (F_{3n+2} - 1)
        && \text{(closed form \(S_n\))}
\end{aligned}$$

Recall the {doc}`formula for the nth Fibonacci number
</prelim/fibonacci-formula>`:

$$ F_n = \frac{1}{\sqrt5}\left(\left(\frac{1+\sqrt5}{2}\right)^n
        - \left(\frac{1-\sqrt5}{2}\right)^n\right) $$

Using this formula, the sum of the first $n$ even Fibonacci numbers becomes:

$$\begin{aligned}
    E_n &= \frac{1}{2} (F_{3n+2} - 1) \\
    &= \frac{1}{2}
        \left(\frac{1}{\sqrt5}\left(\left(\frac{1+\sqrt5}{2}\right)^{3n+2}
        - \left(\frac{1-\sqrt5}{2}\right)^{3n+2}\right) - 1\right) \\
    &= \frac{\left(\frac{1+\sqrt5}{2}\right)^{3n+2}
        - \left(\frac{1-\sqrt5}{2}\right)^{3n+2} - \sqrt5}{2\sqrt5}
\end{aligned}$$

To finally calculate the answer, we need to work out the maximum even Fibonacci
number that is less than or equal to four million. An easy way to do this is
create a table:

$$\begin{array}{c|c}
    n & F_n \\
    \hline
    0 & 0 \\
    3 & 2 \\
    6 & 8 \\
    9 & 34 \\
    12 & 144 \\
    15 & 610 \\
    18 & 2584 \\
    21 & 10946 \\
    24 & 46368 \\
    27 & 196418 \\
    30 & 832040 \\
    33 & 3524578 \\
    \hdashline
    36 & 14930352
\end{array}$$

So $F_{33}$, the 11th even Fibonacci number is the last even Fibonacci number
less than four million:

$$\begin{aligned}
    E_{11} &= \frac{1}{2}(F_{3\cdot11+2} - 1) \\
    &= \frac{1}{2}(F_{35} - 1) \\
    &= \frac{\left(\frac{1+\sqrt5}{2}\right)^{35}
        - \left(\frac{1-\sqrt5}{2}\right)^{35}
        - \sqrt5}{2\sqrt5} \\
    &= 4613732
\end{aligned}$$
